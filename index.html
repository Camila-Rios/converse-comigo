<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador WhatsApp ‚Äî Interativo (Realista)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/imask"></script>
  <style>
    :root{--wa-green:#25D366;}
    html,body{height:100%}
    body{background:linear-gradient(180deg,#071322 0%,#021018 100%);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#fff}
    .frame{width: 100%;
  height: 100vh; /* full viewport height */
  border-radius: 0; /* sem bordas arredondadas no mobile */
  border: none;
  box-shadow: none;
  display: flex;
  flex-direction: column;}
    .top{position: sticky;
  top: 0;
  z-index: 10;
  padding: 12px;
  background: #075e54; /* verde WhatsApp */
  display: flex;
  align-items: center;}
    .avatar{width:44px;height:44px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.08)}
    .meta .name{font-weight:600}
    .messages{flex:1;padding:16px;overflow:auto;background-image:linear-gradient(to bottom, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
    .msg-row{display:flex;margin-bottom:10px;align-items:flex-end}
    .msg-row.me{justify-content:flex-end}
    .bubble{display:inline-block;padding:10px 14px;border-radius:18px;max-width:78%;line-height:1.3;font-size:14px;position:relative}
    .bubble.me{background:#dcf8c6;color:#06331f;border-bottom-right-radius:6px}
    .bubble.her{background:rgba(255,255,255,0.08);color:#fff;border-bottom-left-radius:6px}
    .typing{display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:18px;background:rgba(255,255,255,0.06);width:120px}
    .dot{width:6px;height:6px;background:#fff;border-radius:50%;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.12s}.dot:nth-child(3){animation-delay:.24s}
    @keyframes blink{0%{transform:translateY(0);opacity:.25}50%{transform:translateY(-4px);opacity:1}100%{transform:translateY(0);opacity:.25}}
    .composer{display:flex;gap:10px;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,0.25),rgba(255,255,255,0.02));align-items:center}
    .btn{padding:9px 14px;border-radius:999px;font-weight:600}
    .btn-primary{background:var(--wa-green);color:#06331f}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff}
    .message-audio{display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(0,0,0,0.12);border-radius:12px}
    .play-btn{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;background:rgba(255,255,255,0.06);cursor:pointer;user-select:none}
    .play-btn.playing{background:linear-gradient(90deg,#25d366,#00a884);color:#032c22}
    .audio-meta{display:flex;flex-direction:column}
    .small{font-size:12px;opacity:.85}
    .quick-replies{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .quick-reply{background:rgba(255,255,255,0.06);padding:8px 10px;border-radius:999px;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .quick-reply:hover{background:rgba(255,255,255,0.09)}
    .modal-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:60;padding:16px;}
    .modal{width:100%;max-width:880px;max-height:90vh;overflow-y:auto;background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.04);backdrop-filter: blur(6px)}
    .modal-grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .preview-img{width:100%;height:100%;object-fit:cover;border-radius:10px}
    .pix-card{padding:12px;border-radius:10px;background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.04)}
    .pix-qr{width:150px;height:150px;border-radius:8px;background:rgba(255,255,255,0.02);display:block}
    .form-input{display:block;width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.1);padding:10px 12px;background:rgba(0,0,0,0.3);color:white;margin-bottom:10px;}
    .form-input:focus{outline:none;border-color:#25D366;}
    .hidden{display:none!important;}
    @media(max-width:880px){
      .modal-grid{grid-template-columns:1fr}
      .modal{max-height:95vh;padding:12px;}
      .modal-wrap{padding:8px;}
    }
    @media(max-width:640px){
      .modal-grid{grid-template-columns:1fr;gap:12px;}
      .pix-card{padding:10px;}
      .modal{max-height:98vh;}
    }
    .bubble{transform:translateY(6px);opacity:0;animation:enter .28s forwards}
    @keyframes enter{to{transform:none;opacity:1}}
    .timestamp{font-size:11px;opacity:.7;margin-left:8px;display:block;margin-top:6px}
    /* small wave animation for playing state */
    .wave{width:36px;height:16px;display:inline-block;position:relative}
    .wave span{position:absolute;bottom:0;left:0;width:4px;height:6px;background:#fff;opacity:.7;border-radius:2px;animation:wave 800ms infinite ease-in-out}
    .wave span:nth-child(2){left:6px;animation-delay:100ms}
    .wave span:nth-child(3){left:12px;animation-delay:200ms}
    .wave span:nth-child(4){left:18px;animation-delay:300ms}
    .wave span:nth-child(5){left:24px;animation-delay:400ms}
    @keyframes wave{0%{height:6px;opacity:.6}50%{height:14px;opacity:1}100%{height:6px;opacity:.6}}
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <div class="frame" role="region" aria-label="Simulador WhatsApp - Interativo">
    <div class="top">
      <div class="avatar"><img id="modelAvatarTop" src="./img/perfil.jpeg" alt="Camila" class="w-full h-full object-cover"></div>
      <div class="meta">
        <div class="name">Camila ‚ú®</div>
        <div class="small">‚Ä¢ online</div>
      </div>
      <div class="ml-auto text-right">
        <div class="text-xs">VIP ‚Ä¢ R$19,90</div>
      </div>
    </div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="composer" id="composerStatic">
      <div class="small text-white/80">Responda usando os bot√µes que aparecem nas mensagens.</div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-wrap hidden" role="dialog" aria-modal="true" aria-label="Pr√©via e pagamento">
    <div class="modal">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
          <div class="avatar" style="width:44px;height:44px"><img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=200&auto=format&fit=crop&crop=faces" alt="Camila" class="w-full h-full object-cover rounded-full"></div>
          <div>
            <div class="font-semibold">Camila</div>
            <div class="text-xs text-white/80">Pr√©via escolhida a dedo</div>
          </div>
        </div>
        <button id="closeModal" class="btn btn-ghost">Fechar</button>
      </div>

      <div class="modal-grid">
        <div class="rounded overflow-hidden">
          <img id="previewImage" src="./img/previa.mp4" alt="Pr√©via" class="preview-img">
        </div>

        <div class="flex flex-col gap-3">
          <!-- Formul√°rio de dados do cliente -->
          <div id="customerFormSection" class="pix-card">
            <h3 class="font-semibold mb-3">Seus dados para pagamento</h3>
            <form id="customer-form">
              <input type="text" id="name" placeholder="Nome completo" class="form-input" required>
              <input type="email" id="email" placeholder="E-mail" class="form-input" required>
              <input type="tel" id="phone_number" placeholder="Telefone" class="form-input" required>
              <input type="text" id="pix_cpf" placeholder="CPF" class="form-input" required>
            </form>
            <button id="generatePixBtn" class="btn btn-primary w-full mt-3">Gerar PIX</button>
          </div>

          <!-- Se√ß√£o PIX (inicialmente oculta) -->
          <div id="pixSection" class="pix-card hidden">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-semibold">Pagar via PIX (recomendado)</div>
                <div class="text-xs text-white/80">R$19,90 ‚Ä¢ chave √∫nica gerada</div>
              </div>
              <div class="text-xs text-white/70">Seguro ‚Ä¢ Instant√¢neo</div>
            </div>

            <div class="mt-3 flex gap-3 items-start">
              <img id="pixQR" src="" alt="QR PIX" class="pix-qr" />
              <div class="flex-1">
                <div class="text-xs text-white/80">C√≥digo PIX Copia e Cola</div>
                <textarea id="pixCopyPaste" class="form-input text-xs" rows="3" readonly></textarea>

                <div class="mt-3 flex gap-2">
                  <button id="copyPixButton" class="btn btn-ghost">Copiar C√≥digo</button>
                </div>

                <div class="mt-3">
                  <button id="checkPaymentBtn" class="btn btn-primary">Verificar Pagamento</button>
                </div>

                <div id="pixStatus" class="text-xs mt-3">
                  <div class="text-yellow-400">Status: Aguardando pagamento...</div>
                  <div class="text-white/60 text-xs mt-1">Pague via PIX e clique em "Verificar Pagamento"</div>
                </div>
              </div>
            </div>
          </div>

          <div class="text-xs text-white/80 text-center">Pagamento 100% seguro via TriboPay</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shared audio element -->
  <audio id="sharedAudio" src="https://www.w3schools.com/html/horse.mp3"></audio>

<script>
/* -----------------------------------------
   CONFIGURA√á√ÉO DA TRIBOPAY
------------------------------------------*/
const TRIBOPAY_CONFIG = {
  productInfo: {
    productName: "Camila Rios - Conte√∫do VIP",
    productPrice: 19.90,
    productImage: "./img/perfil.jpeg",
    productHash: "zfjslqxawh", // Substitua pelo hash real
    offerHash: "tllcpnze5p"    // Substitua pelo hash real
  },
  API_ENDPOINT: "https://api.tribopay.com.br/api",
  API_TOKEN: "BCBnDREbCWL7MPgXSTEnzNmpduXGRVI2pg3dGKGTLL965jzySwoKR4R484jm" // Substitua pelo token real
};

/* -----------------------------------------
   Simulador WhatsApp Interativo
------------------------------------------*/
const messagesEl = document.getElementById('messages');
const sharedAudio = document.getElementById('sharedAudio');

// Vari√°veis globais para controle do PIX
let currentTransactionHash = null;
let paymentCheckInterval = null;

// small helper: append a message bubble
function appendBubble(from, innerHTML, opts={withReplies: null, timestamp:true}) {
  const row = document.createElement('div');
  row.className = 'msg-row ' + (from==='me' ? 'me' : '');
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (from==='me' ? 'me' : 'her');
  bubble.innerHTML = innerHTML;
  row.appendChild(bubble);

  if(opts.timestamp) {
    const ts = document.createElement('span');
    ts.className = 'timestamp';
    const now = new Date();
    ts.textContent = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    bubble.appendChild(ts);
  }

  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  if(Array.isArray(opts.withReplies) && opts.withReplies.length){
    const repliesWrap = document.createElement('div');
    repliesWrap.className = 'quick-replies';
    opts.withReplies.forEach(r=>{
      const btn = document.createElement('button');
      btn.className = 'quick-reply';
      btn.textContent = r.text;
      btn.addEventListener('click', ()=> {
        repliesWrap.remove();
        userReply(r.text, r.payload);
      });
      repliesWrap.appendChild(btn);
    });
    bubble.appendChild(repliesWrap);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  return row;
}

// typing indicator
function showTyping(min=500, max=1200){
  const row = document.createElement('div');
  row.className = 'msg-row';
  const t = document.createElement('div');
  t.className = 'typing';
  t.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
  row.appendChild(t);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  const delay = min + Math.random()*(max-min);
  return new Promise(res => setTimeout(()=> { row.remove(); res(); }, delay));
}

// play audio functions (mantidas do c√≥digo original)
function bindPlayButtons(){
  document.querySelectorAll('.play-btn').forEach(btn => {
    if(btn.dataset.bound === 'true') return;
    btn.dataset.bound = 'true';
    btn.addEventListener('click', async (e)=>{
      const isPlaying = btn.classList.contains('playing');
      stopAllPlaying();
      if(isPlaying){
        sharedAudio.pause();
        btn.classList.remove('playing');
        btn.innerHTML = '‚ñ∂';
        removeWave(btn);
        return;
      }
      try {
        sharedAudio.currentTime = 0;
      } catch(e){ }
      btn.classList.add('playing');
      btn.innerHTML = '‚ñÆ‚ñÆ';
      addWave(btn);
      sharedAudio.play().catch(err => {
        console.warn('playback failed', err);
        window.open(sharedAudio.src, '_blank');
        btn.classList.remove('playing');
        btn.innerHTML = '‚ñ∂';
        removeWave(btn);
      });
      sharedAudio.onended = () => {
        btn.classList.remove('playing');
        btn.innerHTML = '‚ñ∂';
        removeWave(btn);
      };
    });
  });
}

function stopAllPlaying(){
  document.querySelectorAll('.play-btn.playing').forEach(btn => {
    btn.classList.remove('playing');
    btn.innerHTML = '‚ñ∂';
    removeWave(btn);
  });
  try { sharedAudio.pause(); } catch(e) {}
}

function addWave(btn){
  if(btn.querySelector('.wave')) return;
  const wave = document.createElement('span');
  wave.className = 'wave';
  wave.innerHTML = '<span></span><span></span><span></span><span></span><span></span>';
  btn.appendChild(wave);
}

function removeWave(btn){
  const w = btn.querySelector('.wave');
  if(w) w.remove();
}

/* -----------------------
   Conversation flow
   -----------------------*/
async function initialSequence(){
  await showTyping(400,900);
  appendBubble('her', 'Oii amorzinho üíã acabei de gravar um √°udio s√≥ pra voc√™.');
  await showTyping(300,700);

  const audioHtml = `
    <div class="message-audio" aria-hidden="false">
      <div class="play-btn" role="button" aria-label="Tocar √°udio">‚ñ∂</div>
      <div class="audio-meta">
        <div class="small font-semibold">√Åudio de Camila ‚Ä¢ 0:12</div>
        <div class="small text-white/70">Toque para ouvir</div>
      </div>
    </div>
  `;
  appendBubble('her', audioHtml);
  bindPlayButtons();

  await showTyping(500,1000);
  appendBubble('her', 'Voc√™ prefere que eu mande a pr√©via agora ou quer um trechinho gr√°tis primeiro?', {
    withReplies: [
      {text: 'Quero ver agora üî•', payload: 'want_now'},
      {text: 'Quero s√≥ um trechinho', payload: 'trecho'},
      {text: 'Depois / N√£o', payload: 'no'}
    ]
  });
  bindPlayButtons();
}

async function userReply(text, payload){
  appendBubble('me', text);

  if(payload === 'want_now'){
    await showTyping(400,900);
    appendBubble('her', 'Ain que del√≠cia üòà vou liberar a pr√©via completa por R$19,90. Quer pagar via PIX (mais r√°pido) ou prefere checkout?');
    await showTyping(300,700);
    appendBubble('her', 'Escolha uma op√ß√£o:', {
      withReplies: [
        {text: 'PIX ‚Äî Quero VIP', payload: 'pix_flow'},
        {text: 'Ir para checkout', payload: 'checkout_flow'}
      ]
    });
  } else if(payload === 'trecho'){
    await showTyping(400,900);
    appendBubble('her', 'Ok, vou mandar um trechinho pra voc√™ agora ‚ù§');
    await showTyping(400,900);
    appendBubble('her', '<img src="https://images.unsplash.com/photo-1503023345310-bd7c1de61c7d?q=80&w=600&auto=format&fit=crop" class="rounded max-w-full"/>');
    await showTyping(400,900);
    appendBubble('her', 'Curtiu? Quer a vers√£o completa por R$19,90?', {
      withReplies: [
        {text: 'Quero sim üî•', payload: 'want_now'},
        {text: 'Ainda n√£o', payload: 'no'}
      ]
    });
  } else if(payload === 'no'){
    await showTyping(400,900);
    appendBubble('her', 'Tranquilo üòè se mudar de ideia me chama aqui. Posso te lembrar mais tarde?');
    appendBubble('her', 'Enquanto isso, posso mandar um mini trechinho gr√°tis para te convencer üòâ', {
      withReplies: [
        {text: 'Manda o trechinho', payload: 'trecho'},
        {text: 'N√£o, obrigada', payload: 'end'}
      ]
    });
  } else if(payload === 'pix_flow'){
    await showTyping(300,700);
    appendBubble('her', 'Perfeito! Vou abrir as op√ß√µes de pagamento ‚Äî escolhe PIX que √© instant√¢neo e eu libero na hora.');
    openModal();
  } else if(payload === 'checkout_flow'){
    await showTyping(300,700);
    appendBubble('her', 'Beleza ‚Äî abrindo o checkout seguro pra voc√™ finalizar.');
    window.open('https://tribopay.com.br', '_blank');
  } else if(payload === 'end'){
    await showTyping(300,700);
    appendBubble('her', 'Beleza, fico por aqui. Me chama quando quiser ‚ù§Ô∏è');
  } else {
    await showTyping(300,700);
    appendBubble('her', 'Haha adorei! Quer que eu libere a pr√©via completa por R$19,90?', {
      withReplies: [
        {text: 'Sim, libera', payload: 'pix_flow'},
        {text: 'N√£o agora', payload: 'no'}
      ]
    });
  }
  bindPlayButtons();
}

/* ----------------------
   Modal + PIX REAL
   ----------------------*/
const modalEl = document.getElementById('modal');
const closeModalBtn = document.getElementById('closeModal');
const customerFormSection = document.getElementById('customerFormSection');
const pixSection = document.getElementById('pixSection');
const generatePixBtn = document.getElementById('generatePixBtn');
const checkPaymentBtn = document.getElementById('checkPaymentBtn');
const copyPixButton = document.getElementById('copyPixButton');
const pixStatus = document.getElementById('pixStatus');

closeModalBtn.addEventListener('click', closeModal);

function openModal(){ 
  modalEl.classList.remove('hidden');
  resetPaymentUI();
  
  modalEl.addEventListener('click', function(e) {
    if (e.target === modalEl) {
      closeModal();
    }
  });
}

function closeModal() {
  modalEl.classList.add('hidden');
  if (paymentCheckInterval) {
    clearInterval(paymentCheckInterval);
    paymentCheckInterval = null;
  }
}

function resetPaymentUI() {
  customerFormSection.classList.remove('hidden');
  pixSection.classList.add('hidden');
  currentTransactionHash = null;
  document.getElementById('customer-form').reset();
}

/* ----------------------
   INTEGRA√á√ÉO TRIBOPAY REAL
   ----------------------*/

// Gerar PIX
generatePixBtn.addEventListener('click', async () => {
  const form = document.getElementById('customer-form');
  if (!form.checkValidity()) {
    alert('Por favor, preencha todos os campos corretamente.');
    return form.reportValidity();
  }

  generatePixBtn.textContent = 'Gerando PIX...';
  generatePixBtn.disabled = true;

  const customerData = {
    name: document.getElementById('name').value,
    email: document.getElementById('email').value,
    phone_number: document.getElementById('phone_number').value.replace(/\D/g, ''),
    document: document.getElementById('pix_cpf').value.replace(/\D/g, ''),
    street_name: "N√£o informado",
    number: "s/n",
    complement: "",
    neighborhood: "N√£o informado",
    city: "N√£o informado",
    state: "NI",
    zip_code: "00000000"
  };

  const paymentPayload = {
    amount: Math.round(TRIBOPAY_CONFIG.productInfo.productPrice * 100),
    offer_hash: TRIBOPAY_CONFIG.productInfo.offerHash,
    payment_method: 'pix',
    customer: customerData,
    cart: [{
      product_hash: TRIBOPAY_CONFIG.productInfo.productHash,
      title: TRIBOPAY_CONFIG.productInfo.productName,
      price: Math.round(TRIBOPAY_CONFIG.productInfo.productPrice * 100),
      quantity: 1,
      operation_type: 1,
      tangible: false
    }],
    installments: 1,
    expire_in_days: 1,
    transaction_origin: 'api'
  };

  try {
    // Criar transa√ß√£o
    const response = await fetch(`${TRIBOPAY_CONFIG.API_ENDPOINT}/public/v1/transactions?api_token=${TRIBOPAY_CONFIG.API_TOKEN}`, {
      method: 'POST',
      headers: { 
        'Accept': 'application/json', 
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify(paymentPayload)
    });

    const text = await response.text();
    let result;
    try { 
      result = JSON.parse(text); 
    } catch { 
      result = { raw: text }; 
    }

    if (!response.ok) {
      const msg = result?.message || 'Ocorreu um erro ao gerar o PIX.';
      const errs = result?.errors ? '\n' + Object.values(result.errors).map(e => e[0]).join('\n') : '';
      throw new Error(msg + errs);
    }

    const hash = result?.hash || result?.data?.hash || result?.transaction_hash || result?.id;
    if (!hash) throw new Error('Transa√ß√£o criada, mas sem hash na resposta.');

    currentTransactionHash = hash;

    // Buscar dados do PIX
    const transactionResponse = await fetchTransactionByHash(hash);
    if (!transactionResponse.ok) throw new Error('N√£o foi poss√≠vel obter os dados do PIX.');

    const data = transactionResponse.json.data || transactionResponse.json;
    const pixData = data.pix || {};
    const copyPaste = (pixData.pix_qr_code || pixData.qr_code || pixData.copy_paste || pixData.code || '').trim();

    if (!copyPaste) throw new Error('C√≥digo PIX n√£o dispon√≠vel.');

    // Mostrar UI do PIX
    document.getElementById('pixCopyPaste').value = copyPaste;
    
    // Gerar QR Code visual
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(copyPaste)}`;
    document.getElementById('pixQR').src = qrUrl;

    customerFormSection.classList.add('hidden');
    pixSection.classList.remove('hidden');

    // Iniciar verifica√ß√£o autom√°tica
    startPaymentChecking();

  } catch (error) {
    console.error('Erro ao gerar PIX:', error);
    alert(`Erro: ${error.message || 'Falha na comunica√ß√£o com o servidor.'}`);
    generatePixBtn.textContent = 'Gerar PIX';
    generatePixBtn.disabled = false;
  }
});

// Verificar pagamento
checkPaymentBtn.addEventListener('click', checkPaymentStatus);

// Copiar c√≥digo PIX
copyPixButton.addEventListener('click', async () => {
  const text = document.getElementById('pixCopyPaste').value.trim();
  if (!text) { 
    alert('C√≥digo PIX n√£o dispon√≠vel.'); 
    return; 
  }

  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
    } else {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.focus(); 
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
    copyPixButton.textContent = 'Copiado!';
    setTimeout(() => { copyPixButton.textContent = 'Copiar C√≥digo'; }, 2000);
  } catch (e) {
    console.error(e);
    copyPixButton.textContent = 'Falhou ao copiar';
    setTimeout(() => { copyPixButton.textContent = 'Copiar C√≥digo'; }, 2000);
  }
});

/* ----------------------
   FUN√á√ïES DA API TRIBOPAY
   ----------------------*/
async function fetchTransactionByHash(hash) {
  const url = `${TRIBOPAY_CONFIG.API_ENDPOINT}/public/v1/transactions/${hash}?api_token=${TRIBOPAY_CONFIG.API_TOKEN}`;
  const response = await fetch(url, { 
    headers: { 
      'Accept': 'application/json' 
    } 
  });
  
  const text = await response.text();
  let json;
  try { 
    json = JSON.parse(text); 
  } catch { 
    json = { raw: text }; 
  }
  
  return { 
    ok: response.ok, 
    status: response.status, 
    json: json 
  };
}

async function checkPaymentStatus() {
  if (!currentTransactionHash) return;

  checkPaymentBtn.textContent = 'Verificando...';
  checkPaymentBtn.disabled = true;

  try {
    const { ok, json } = await fetchTransactionByHash(currentTransactionHash);
    
    if (!ok) {
      throw new Error('Falha ao verificar pagamento');
    }

    const data = json.data || json;
    const status = String(data.payment_status || data.status || '').toLowerCase();

    if (status === 'paid' || status === 'approved') {
      // Pagamento confirmado
      pixStatus.innerHTML = '<div class="text-green-400">‚úÖ Pagamento confirmado! Liberando conte√∫do...</div>';
      
      setTimeout(() => {
        closeModal();
        appendBubble('her', 'Prontinho! Pagamento confirmado ‚úÖ Aqui est√° a pr√©via exclusiva ‚ù§Ô∏è');
        appendBubble('her', '<img src="https://images.unsplash.com/photo-1503023345310-bd7c1de61c7d?q=80&w=600&auto=format&fit=crop" class="rounded max-w-full"/>');
        appendBubble('her', 'Obrigada pelo apoio! Se quiser mais conte√∫do especial, √© s√≥ me chamar üòò');
      }, 1500);

      if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
        paymentCheckInterval = null;
      }

    } else if (status === 'waiting_payment' || status === 'pending') {
      pixStatus.innerHTML = '<div class="text-yellow-400">‚è≥ Aguardando pagamento...</div>';
      checkPaymentBtn.textContent = 'Verificar Pagamento';
      checkPaymentBtn.disabled = false;
    } else {
      pixStatus.innerHTML = `<div class="text-red-400">‚ùå Status: ${status}</div>`;
      checkPaymentBtn.textContent = 'Verificar Pagamento';
      checkPaymentBtn.disabled = false;
    }

  } catch (error) {
    console.error('Erro ao verificar pagamento:', error);
    pixStatus.innerHTML = '<div class="text-red-400">‚ùå Erro ao verificar pagamento</div>';
    checkPaymentBtn.textContent = 'Verificar Pagamento';
    checkPaymentBtn.disabled = false;
  }
}

function startPaymentChecking() {
  // Verificar a cada 10 segundos
  paymentCheckInterval = setInterval(checkPaymentStatus, 10000);
}

/* ----------------------
   INICIALIZA√á√ÉO
   ----------------------*/
document.addEventListener('DOMContentLoaded', () => {
  // Aplicar m√°scaras
  IMask(document.getElementById('phone_number'), { mask: '(00) 00000-0000' });
  IMask(document.getElementById('pix_cpf'), { mask: '000.000.000-00' });
  
  // Iniciar conversa
  initialSequence();
});

// Helper: toast notification
function toast(text){
  const t = document.createElement('div');
  t.textContent = text;
  t.style.position='fixed'; t.style.left='50%'; t.style.transform='translateX(-50%)';
  t.style.bottom='28px'; t.style.padding='10px 14px'; t.style.borderRadius='999px';
  t.style.background='rgba(0,0,0,0.6)'; t.style.color='#fff'; t.style.zIndex=9999; t.style.fontSize='13px';
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity = '0',1800);
  setTimeout(()=> t.remove(),2300);
}

</script>
</body>
</html>
